SELECT esd.EXTERNAL_SYSTEM_ID, co.CUSTOMER_ORDER_ID, vi.PROCESS_INST_ID
  FROM EXTERNAL_SYSTEM_DATA esd
       LEFT OUTER JOIN customer_order co
          ON esd.OWNER_ID = co.CUSTOMER_ORDER_ID
       LEFT OUTER JOIN variable_instance vi
          ON TO_CHAR (co.CUSTOMER_ORDER_ID) = vi.VARIABLE_VALUE
 WHERE     vi.PROCESS_INST_ID IN (SELECT PROCESS_INSTANCE_ID
                                    FROM activity_instance
                                   WHERE     ACTIVITY_ID IN (SELECT work_id
                                                               FROM WORK
                                                              WHERE work_name =
                                                                       'Activate TNs in CNUM')
                                         AND STATUS_CD = 3
                                         AND START_DT >= SYSDATE - 365)
       AND co.CMPLT_DATE IS NULL
       AND esd.EXTERNAL_SYSTEM_NAME = 'NETWORK_SYSTEM'
       AND OWNER_TYPE = 'ORDER'

select dn.directory_number,da.value from directory_number dn JOIN DN_ATTRIBUTE da ON da.DIRECTORY_NUMBER_ID = dn.DIRECTORY_NUMBER_ID
where da.directory_number_id  in
(select owner_id from customer_order_item where customer_order_id in( 1044376) and owner_type='DIRECTORY_NUMBER') 
and NAME='NT_ORDER_ID'


SELECT coi.customer_order_id,
         vi.PROCESS_INST_ID,
         da.VALUE as CNUM_ID,
         COUNT (coi.CUSTOMER_ORDER_ID) TN_COUNT
    FROM DIRECTORY_NUMBER dn
         JOIN CUSTOMER_ORDER_ITEM coi ON dn.DIRECTORY_NUMBER_ID = coi.OWNER_ID
         JOIN EXTERNAL_SYSTEM_DATA esd ON coi.CUSTOMER_ORDER_ID = esd.OWNER_ID
         JOIN CUSTOMER_ORDER co ON coi.CUSTOMER_ORDER_ID = co.CUSTOMER_ORDER_ID
         JOIN VARIABLE_INSTANCE vi
            ON TO_CHAR (co.CUSTOMER_ORDER_ID) = vi.VARIABLE_VALUE
         JOIN DN_ATTRIBUTE da ON da.DIRECTORY_NUMBER_ID = dn.DIRECTORY_NUMBER_ID   
   WHERE     vi.PROCESS_INST_ID IN (SELECT PROCESS_INSTANCE_ID
                                      FROM ACTIVITY_INSTANCE
                                     WHERE     ACTIVITY_ID IN (SELECT WORK_ID
                                                                 FROM WORK
                                                                WHERE WORK_NAME =
                                                                         'Activate TNs in CNUM')
                                           AND STATUS_CD = 3
                                           AND START_DT >= SYSDATE - 365)
         AND co.CMPLT_DATE IS NULL
         AND esd.EXTERNAL_SYSTEM_NAME = 'NETWORK_SYSTEM'
         AND esd.OWNER_TYPE = 'ORDER'
         AND coi.OWNER_TYPE = 'DIRECTORY_NUMBER'
         AND da.NAME='NT_ORDER_ID'
GROUP BY coi.CUSTOMER_ORDER_ID,da.VALUE, vi.PROCESS_INST_ID

SELECT coi.customer_order_id,
         vi.PROCESS_INST_ID,
         da.VALUE as CNUM_ID,
         COUNT (coi.CUSTOMER_ORDER_ID) TN_COUNT
    FROM DIRECTORY_NUMBER dn
         JOIN CUSTOMER_ORDER_ITEM coi ON dn.DIRECTORY_NUMBER_ID = coi.OWNER_ID
         JOIN EXTERNAL_SYSTEM_DATA esd ON coi.CUSTOMER_ORDER_ID = esd.OWNER_ID
         JOIN CUSTOMER_ORDER co ON coi.CUSTOMER_ORDER_ID = co.CUSTOMER_ORDER_ID
         JOIN VARIABLE_INSTANCE vi
            ON TO_CHAR (co.CUSTOMER_ORDER_ID) = vi.VARIABLE_VALUE
         JOIN DN_ATTRIBUTE da ON da.DIRECTORY_NUMBER_ID = dn.DIRECTORY_NUMBER_ID
         JOIN ACTIVITY_INSTANCE ai ON vi.PROCESS_INST_ID = ai.PROCESS_INSTANCE_ID
         JOIN WORK w ON ai.ACTIVITY_ID = w.WORK_ID
    WHERE w.WORK_NAME = 'Activate TNs in CNUM'
         AND ai.STATUS_CD = 3
         AND ai.START_DT >= SYSDATE - 365
         AND co.CMPLT_DATE IS NULL
         AND esd.EXTERNAL_SYSTEM_NAME = 'NETWORK_SYSTEM'
         AND esd.OWNER_TYPE = 'ORDER'
         AND coi.OWNER_TYPE = 'DIRECTORY_NUMBER'
         AND da.NAME='NT_ORDER_ID'
GROUP BY coi.CUSTOMER_ORDER_ID,da.VALUE, vi.PROCESS_INST_ID

SELECT esd.EXTERNAL_SYSTEM_ID ENGG_ORDER,
         coi.customer_order_id,
         vi.PROCESS_INST_ID,
         da.VALUE as CNUM_ID,
         COUNT (coi.CUSTOMER_ORDER_ID) TN_COUNT
    FROM DIRECTORY_NUMBER dn
         JOIN CUSTOMER_ORDER_ITEM coi ON dn.DIRECTORY_NUMBER_ID = coi.OWNER_ID
         JOIN EXTERNAL_SYSTEM_DATA esd ON coi.CUSTOMER_ORDER_ID = esd.OWNER_ID
         JOIN CUSTOMER_ORDER co ON coi.CUSTOMER_ORDER_ID = co.CUSTOMER_ORDER_ID
         JOIN VARIABLE_INSTANCE vi
            ON TO_CHAR (co.CUSTOMER_ORDER_ID) = vi.VARIABLE_VALUE
         JOIN DN_ATTRIBUTE da ON da.DIRECTORY_NUMBER_ID = dn.DIRECTORY_NUMBER_ID
         JOIN ACTIVITY_INSTANCE ai ON vi.PROCESS_INST_ID = ai.PROCESS_INSTANCE_ID
         JOIN WORK w ON ai.ACTIVITY_ID = w.WORK_ID
    WHERE w.WORK_NAME = 'Activate TNs in CNUM'
         AND ai.STATUS_CD = 3
         AND ai.START_DT >= SYSDATE - 365
         AND co.CMPLT_DATE IS NULL
         AND esd.EXTERNAL_SYSTEM_NAME = 'NETWORK_SYSTEM'
         AND esd.OWNER_TYPE = 'ORDER'
         AND coi.OWNER_TYPE = 'DIRECTORY_NUMBER'
         AND da.NAME='NT_ORDER_ID'
GROUP BY esd.EXTERNAL_SYSTEM_ID,coi.CUSTOMER_ORDER_ID,da.VALUE, vi.PROCESS_INST_ID

https://ngwm.qintra.com/orderdashboard/?exclusiveModule=orderDashboard


WITH DN_ID
     AS (SELECT owner_id
           FROM customer_order_item
          WHERE     customer_order_id IN (SELECT owner_id
                                            FROM external_system_data a
                                           WHERE EXTERNAL_SYSTEM_ID = '&n1')
                AND owner_type = 'DIRECTORY_NUMBER')
SELECT directory_number_id
  FROM directory_number
 WHERE     directory_number IN (SELECT directory_number
                                  FROM directory_number a
                                 WHERE directory_number_id IN (SELECT *
                                                                 FROM DN_ID))
       AND DN_CLOSE_DATE IS NULL
       AND status_cd != 12
MINUS
SELECT directory_number_id
  FROM directory_number a
 WHERE directory_number_id IN (SELECT *
                                 FROM DN_ID)                                     


select a.*,rowid from directory_number a where directory_number_id  in
(select owner_id from customer_order_item where customer_order_id in( select owner_id from external_system_data a where EXTERNAL_SYSTEM_ID='&Order'
) and owner_type='DIRECTORY_NUMBER') 


DECLARE

i number;

TYPE phone_no_tab IS VARRAY(1000) OF VARCHAR2(20);
phone_nos phone_no_tab := phone_no_tab(&n
);

BEGIN
for i in phone_nos.FIRST..phone_nos.LAST

loop
            if phone_nos.exists(i) then

UPDATE CONTACT SET contact_close_date=sysdate,comments=comments || '' WHERE CONTACT_CLOSE_DATE IS NULL AND contact_id IN
                (SELECT contact_id FROM contact WHERE owner_type='DIRECTORY_NUMBER' AND OWNER_ID=phone_nos(i));
                
                UPDATE equipment_dn_mapping SET mapping_close_date=sysdate,comments=comments ||''
                WHERE directory_number_id=phone_nos(i);
                
                UPDATE dn_attribute SET mapping_close_date=sysdate,status_cd=12 
                WHERE directory_number_id=phone_nos(i);
                
                UPDATE dn_feature_mapping SET mapping_close_date=sysdate,comments=comments ||''  
                WHERE directory_number_id=phone_nos(i);
                
                UPDATE address_mapping SET mapping_close_date=sysdate,status_cd=12,comments=comments ||''  
                WHERE owner_type='DIRECTORY_NUMBER' AND owner_id=phone_nos(i);
                
                UPDATE package_instance_dn_mapping SET mapping_close_date=sysdate,comments=comments ||''
                WHERE DIRECTORY_NUMBER_ID=phone_nos(i);
                                                
                UPDATE directory_number SET dn_close_date=sysdate,status_cd=12,comments=comments ||'' 
                WHERE directory_number_id=phone_nos(i);  

                                UPDATE package_instance
                                 SET pkg_instance_close_date = sysdate, status_cd = 12, mod_dt = SYSDATE, mod_usr = 'FALLOUT',comments=comments ||''
                                                WHERE package_instance_id in (select package_instance_id from package_instance_dn_mapping where directory_number_id = phone_nos(i));



end if;

END LOOP;


dbms_output.put_line('Given list of TNs purged successfully from OMWF ');

END;

select count(*) from directory_number where directory_number in(
select directory_number from directory_number a where directory_number_id  in
(select owner_id from customer_order_item where customer_order_id in( select owner_id from external_system_data a where EXTERNAL_SYSTEM_ID='181773953'
) and owner_type='DIRECTORY_NUMBER') ) and DN_CLOSE_DATE is null and status_cd!=12


